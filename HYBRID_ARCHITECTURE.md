# Гибридная Архитектура AI Сервисов

## Обзор

Гибридная архитектура AI сервисов разработана для поддержки как SFW (Safe For Work), так и NSFW (Not Safe For Work) контента в российских условиях, где местные AI сервисы имеют встроенную модерацию.

### Проблема

Российские AI сервисы (например, YandexGPT, GigaChat) имеют встроенную модерацию, которая блокирует генерацию NSFW контента. Это ограничение делает невозможным создание взрослых персонажей или интимных сценариев.

### Решение

Гибридная архитектура использует два AI сервиса параллельно:
- **Российский AI** (YandexGPT/GigaChat) - для SFW контента
- **Gemini AI** (Google) - для NSFW контента

## Архитектура

### Основные Компоненты

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   App.tsx       │────│  hybridAIService │────│ Russian AI      │
│                 │    │                  │    │ (Yandex/Giga)   │
│ UI + Logic      │    │ Router           │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         │              ┌──────────────────┐             │
         └──────────────│ contentClassifier│─────────────┘
                        │                  │
                        │ NSFW/SFW Logic   │
                        └──────────────────┘
                                 │
                        ┌──────────────────┐
                        │ Gemini AI        │
                        │ (Google)         │
                        │                  │
                        └──────────────────┘
```

### Сервисы

#### 1. `hybridAIService.ts`
Центральный маршрутизатор, который:
- Определяет тип контента (SFW vs NSFW)
- Направляет запросы к соответствующему AI сервису
- Обеспечивает единый интерфейс для всех операций

#### 2. `contentClassifier.ts`
Алгоритм определения типа контента:
- Анализирует промпты и контекст
- Использует ключевые слова и паттерны
- Предоставляет возможность ручного переопределения

#### 3. `geminiService.ts`
Сервис для работы с Gemini AI:
- Генерирует NSFW контент без модерации
- Поддерживает все основные функции (чат, изображения, видео)
- Совместим с интерфейсом российского AI

#### 4. `russianAIService.ts`
Сервис для работы с российскими AI:
- YandexGPT или GigaChat
- Только SFW контент
- Базовая функциональность

## Настройка

### 1. API Ключи

Создайте файл `.env` в корне проекта:

```bash
# Российский AI сервис
VITE_RUSSIAN_AI_API_KEY=your_russian_ai_api_key_here
VITE_RUSSIAN_AI_BASE_URL=https://api.yandex.ru/gpt
VITE_RUSSIAN_AI_MODEL=yandexgpt

# Gemini AI сервис (для NSFW)
VITE_GEMINI_API_KEY=your_gemini_api_key_here
VITE_GEMINI_BASE_URL=https://generativelanguage.googleapis.com/v1beta
VITE_GEMINI_MODEL=gemini-pro

# Настройки гибридного режима
VITE_HYBRID_MODE_ENABLED=true
VITE_HYBRID_DEFAULT_MODE=auto
VITE_NSFW_DETECTION_STRICTNESS=medium
```

### 2. Получение API Ключей

#### YandexGPT
1. Перейдите на [cloud.yandex.ru](https://cloud.yandex.ru)
2. Создайте сервисный аккаунт
3. Получите IAM токен для доступа к YandexGPT
4. Добавьте ключ в `.env` как `VITE_RUSSIAN_AI_API_KEY`

#### Gemini AI
1. Перейдите на [ai.google.dev](https://ai.google.dev)
2. Создайте API ключ для Gemini
3. Добавьте ключ в `.env` как `VITE_GEMINI_API_KEY`

### 3. Конфигурация

#### Режимы Работы

**Автоматический режим (`auto`)**:
- Система автоматически определяет тип контента
- SFW → Российский AI
- NSFW → Gemini AI

**Принудительный режим (`sfw`)**:
- Все запросы идут через российский AI
- NSFW контент будет отклонен

**Принудительный режим (`nsfw`)**:
- Все запросы идут через Gemini AI
- Может генерировать любой контент

#### Строгость Определения NSFW

- `low`: Только явные NSFW ключевые слова
- `medium`: Средний уровень фильтрации
- `high`: Агрессивное определение потенциального NSFW контента

## Использование

### UI Элементы

В главном интерфейсе добавлены элементы управления:

1. **Переключатель режима**: Авто/SFW/NSFW
2. **Индикатор активного сервиса**: Показывает, какой AI используется
3. **Панель статуса**: Информация о доступности сервисов

### Программное Использование

```typescript
import { hybridAIService } from './services/hybridAIService';

// Автоматическое определение
const response = await hybridAIService.streamCharacterResponse(
    'Имя персонажа',
    'Описание',
    'Биография',
    'Контекст эволюции',
    'История сообщений',
    'Имена других персонажей',
    false, // isNSFW - будет определен автоматически
    null,   // image
    (chunk) => console.log(chunk)
);

// Принудительный NSFW режим
hybridAIService.setMode('nsfw');
```

## Принципы Работы

### Определение Типа Контента

Система анализирует следующие факторы:

1. **Ключевые слова**: Явные NSFW термины
2. **Контекст**: Предыдущие сообщения в чате
3. **Настройки чата**: Флаг `isNSFW` в сессии
4. **Ручное переопределение**: Пользовательский выбор режима

### Маршрутизация Запросов

```
Входящий запрос
       ↓
┌─────────────────┐
│ contentClassifier│
└─────────────────┘
       ↓
┌─────────────────┐
│  Определение    │
│  SFW vs NSFW    │
└─────────────────┘
       ↓
    ┌─────┴─────┐
    ↓           ↓
SFW режим   NSFW режим
    ↓           ↓
┌─────────┐ ┌─────────┐
│Russian  │ │Gemini   │
│AI       │ │AI       │
└─────────┘ └─────────┘
    ↓           ↓
└─────────────┐
│  Единый     │
│  Ответ      │
└─────────────┘
```

### Fallback Механизмы

1. **Первичный сервис недоступен**:
   - Автоматическое переключение на резервный
   - Логирование ошибок для отладки

2. **API лимиты превышены**:
   - Попытка использовать другой сервис
   - Показ сообщения об ошибке пользователю

3. **Неопределенный тип контента**:
   - Использование российского AI как безопасного варианта
   - Предложение пользователю выбрать режим вручную

## Безопасность и Ограничения

### Конфиденциальность

- API ключи хранятся только в браузере
- Никакие данные не отправляются на сторонние серверы
- Локальное хранение настроек

### Ограничения

1. **Географические**: Gemini может быть недоступен в некоторых регионах
2. **Лимиты API**: Каждый сервис имеет свои ограничения
3. **Качество контента**: Разные AI могут давать разные результаты

### Рекомендации

- Регулярно проверяйте доступность API ключей
- Мониторьте использование лимитов
- Настройте логирование для отладки

## Отладка и Устранение Неисправностей

### Общие Проблемы

#### 1. "Сервис недоступен"
**Причины**:
- Неверный API ключ
- Проблемы с сетью
- Превышены лимиты API

**Решения**:
- Проверьте API ключи в `.env`
- Проверьте подключение к интернету
- Попробуйте переключить режим

#### 2. NSFW контент блокируется
**Причины**:
- Российский AI используется вместо Gemini
- Неправильная настройка режима

**Решения**:
- Переключитесь в режим "NSFW" или "Авто"
- Проверьте настройки API ключей

#### 3. Медленная работа
**Причины**:
- Высокая латентность API
- Проблемы с сетью

**Решения**:
- Проверьте статус сервисов в UI
- Попробуйте перезагрузить страницу

### Логирование

Для отладки включите подробное логирование:

```typescript
// В консоли браузера
localStorage.setItem('debugHybridAI', 'true');
```

### Проверка Конфигурации

```typescript
// Проверьте настройки в консоли
console.log('Hybrid AI Config:', {
    mode: localStorage.getItem('hybridMode'),
    apiKeys: {
        russian: !!import.meta.env.VITE_RUSSIAN_AI_API_KEY,
        gemini: !!import.meta.env.VITE_GEMINI_API_KEY
    }
});
```

## Расширение и Модификация

### Добавление Новых AI Сервисов

1. Создайте новый сервис в `services/`
2. Реализуйте стандартный интерфейс
3. Добавьте логику маршрутизации в `hybridAIService`
4. Обновите UI для новых опций

### Кастомизация Определения NSFW

Отредактируйте `contentClassifier.ts`:

```typescript
const customKeywords = {
    nsfw: [
        // Добавьте свои ключевые слова
        'ваше_ключевое_слово'
    ],
    sfw: [
        // Исключения, которые считаются безопасными
        'безопасное_слово'
    ]
};
```

## Поддержка и Контакты

При возникновении проблем:

1. Проверьте этот документ
2. Включите логирование и проверьте консоль
3. Убедитесь в правильности настроек API
4. Попробуйте перезагрузить приложение

---

*Этот документ описывает гибридную архитектуру AI сервисов версии 1.0. Для обновлений и изменений следите за репозиторием проекта.*